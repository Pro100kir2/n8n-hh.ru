# HH.ru Automation Setup Guide

## Обзор

Этот проект автоматизирует поиск и отклик на вакансии на HH.ru с использованием:
- **Python backend** - поиск вакансий через Playwright
- **n8n workflow** - оркестрация процесса
- **Google Gemini AI** - генерация персонализированных сопроводительных писем

---

## Установка и Настройка

### 1. Python Dependencies

Убедитесь что установлены все зависимости:

```bash
pip install playwright python-dotenv
playwright install chromium
```

### 2. Настройка переменных окружения (.env)

Проект использует файл `.env` для хранения локальных настроек. Создайте файл `.env` в корневом каталоге (он уже добавлен в `.gitignore`):

```env
# Путь к директории с сессиями (куда n8n сохраняет файлы)
N8N_FILES_DIR=C:\Users\Joindev\.n8n-files

# Настройки прокси-сервера
SERVER_HOST=127.0.0.1
SERVER_PORT=8000

# Настройки поиска по умолчанию
DEFAULT_SEARCH_TEXT=Frontend
AREA_CODE=113
```

### 3. Настройка Google Gemini API

#### Шаг 1: Получение API ключа

1. Перейдите на [Google AI Studio](https://makersuite.google.com/app/apikey)
2. Войдите с Google аккаунтом
3. Нажмите "Get API Key" или "Create API Key"
4. Скопируйте полученный ключ

#### Шаг 2: Добавление credentials в n8n

1. Откройте n8n UI (обычно `http://localhost:5678`)
2. Перейдите в **Settings** → **Credentials**
3. Нажмите **Add Credential**
4. Выберите **Google PaLM API** (используется для Gemini)
5. Вставьте ваш API ключ
6. Назовите credential "Google Gemini API"
7. Сохраните

### 3. Импорт Workflow в n8n

1. Откройте n8n
2. Нажмите **+ New Workflow** или откройте существующий
3. Нажмите на меню (три точки) → **Import from File**
4. Выберите файл `HH.ru Flow (With AI and Pagination).json`
5. После импорта убедитесь что нода "Call Gemini API" подключена к созданному credential

### 4. Настройка Параметров Workflow

В ноде **Initialize Settings** можно настроить:

- `search_query` - поисковый запрос (например, "Frontend", "Python Developer")
- `current_page` - начальная страница (обычно 0)
- `max_pages` - максимальное количество страниц для обработки (рекомендуется 3-5)

---

## Запуск Системы

### Шаг 1: Запустите Python сервер

```bash
python hh_server.py
```

Вы должны увидеть:
```
HH Proxy Server running on http://127.0.0.1:8000
Endpoints:
  GET  /search?text=Frontend
  POST /apply  { 'url': '...', 'message': '...' }
```

### Шаг 2: Запустите n8n

```bash
n8n start
```

Откройте браузер: `http://localhost:5678`

### Шаг 3: Запустите Workflow

1. Откройте workflow "HH.ru Flow (With AI and Pagination)"
2. Нажмите **Execute Workflow**
3. Наблюдайте за процессом в реальном времени

---

## Как Работает Workflow

### Структура Потока

```
1. Initialize Settings
   ↓
2. Search Vacancies (page 0)
   ↓
3. Has Results? (проверка есть ли вакансии)
   ↓
4. Loop Over Vacancies (перебор каждой вакансии)
   ↓
5. Prepare AI Prompt (подготовка промпта для Gemini)
   ↓
6. Call Gemini API (генерация сопроводительного письма)
   ↓
7. Prepare Apply Data (подготовка данных для отклика)
   ↓
8. Apply to Vacancy (отправка отклика)
   ↓
9. Wait 5s (задержка)
   ↓
10. More Pages? (есть ли еще страницы?)
    ↓ (если да)
11. Increment Page → возврат к шагу 2
```

### Ключевые Особенности

- **Пагинация**: обрабатывает несколько страниц вакансий (по 20 на страницу)
- **AI-письма**: каждое письмо генерируется индивидуально для вакансии
- **Задержки**: 5 секунд между откликами для избежания блокировки
- **Безопасность**: использует сохраненную сессию из `hh_session.json`

---

## Настройка AI Промпта

Промпт находится в ноде **Prepare AI Prompt**. Текущая версия:

```
Напиши профессиональное сопроводительное письмо для отклика на вакансию:

Название: {{ $json.title }}
Компания: {{ $json.employer }}

Требования:
- Длина: 3-4 предложения
- Тон: профессиональный, но дружелюбный
- Укажи что у тебя есть релевантный опыт во frontend разработке
- Без излишней формальности
- На русском языке
```

### Кастомизация Промпта

Вы можете:
1. Добавить информацию о вашем опыте
2. Изменить тон (более формальный/неформальный)
3. Увеличить/уменьшить длину
4. Добавить специфичные навыки

**Пример:**
```
Напиши профессиональное сопроводительное письмо для отклика на вакансию:

Название: {{ $json.title }}
Компания: {{ $json.employer }}

О кандидате:
- Опыт: 5 лет во frontend разработке
- Технологии: React, Vue.js, TypeScript, Node.js
- Достижения: разработал 10+ SPA приложений

Требования к письму:
- Длина: 4-5 предложений
- Упомяни конкретный опыт с технологиями из описания вакансии
- Покажи энтузиазм к компании
- На русском языке
```

---

## Тестирование

### Тест 1: Проверка Pagination

```bash
# Поиск на странице 0
curl "http://127.0.0.1:8000/search?text=Frontend&page=0"

# Поиск на странице 1
curl "http://127.0.0.1:8000/search?text=Frontend&page=1"
```

Вы должны получить JSON с 20 вакансиями для каждой страницы.

### Тест 2: Проверка Gemini API

В n8n:
1. Создайте тестовый workflow
2. Добавьте HTTP Request node
3. Настройте запрос к Gemini API (как в "Call Gemini API")
4. Выполните и проверьте ответ

---

## Troubleshooting

### Проблема: "Session file not found"

**Решение:** Запустите `hh_login.py` для создания сессии:
```bash
python hh_login.py
```

### Проблема: "API key invalid" от Gemini

**Решение:** 
1. Проверьте что API ключ скопирован полностью
2. Убедитесь что Gemini API включен в вашем Google Cloud проекте
3. Попробуйте создать новый ключ

### Проблема: Workflow останавливается на первой странице

**Решение:**
1. Проверьте что нода "More Pages?" правильно подключена к "Increment Page"
2. Убедитесь что `max_pages > 1` в "Initialize Settings"

### Проблема: Слишком много откликов, получил бан

**Решение:**
1. Уменьшите `max_pages` до 2-3
2. Увеличьте задержку в "Wait 5s" до 10-15 секунд
3. Запускайте workflow не чаще 1 раза в день

---

## Мониторинг и Логи

### Python Server Logs

Сервер логирует все запросы:
```
2026-01-03 15:30:00 [INFO] HHServer: Processing Search Request: Frontend, page 0
2026-01-03 15:30:05 [INFO] HHServer: Processing Apply Request for: https://hh.ru/vacancy/123456
```

### n8n Execution Logs

В n8n UI можно посмотреть:
- Выполнение каждой ноды
- Входные/выходные данные
- Ошибки и таймауты

---

## Best Practices

1. **Не превышайте лимиты**: 3-5 страниц (60-100 вакансий) за запуск
2. **Используйте задержки**: минимум 5 секунд между откликами
3. **Персонализируйте промпт**: чем конкретнее, тем лучше результат
4. **Мониторьте аккаунт**: следите за статистикой откликов в HH.ru
5. **Обновляйте сессию**: раз в неделю запускайте `hh_login.py`

---

## Стоимость Google Gemini API

- **Бесплатный tier**: 60 запросов в минуту
- **Стоимость на платном плане**: ~$0.00025 за 1000 символов
- **Примерная стоимость**: за 100 писем ≈ $0.05-0.10

Для автоматизации откликов бесплатного tier более чем достаточно.
